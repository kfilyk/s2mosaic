# S2Mosaic
CSC462 Project @ UVIC

Our algorithm compiles several weeks of sentinel2 satellite data into a cloud-free, histogram-corrected multi-band maps.

## Process
This was originally a project focused on detecting garbage alone coastal waters but we first had to solve the problem of cloud removal and mosaicking which would have otherwise made garbage detection impossible.



Each tile has 12 bands and a few other extra bands we we can download. The image below is an image with RGB ands combined and modified for just viewing purposes.

<img src="/READMImages/accra_l2a_rgb.png" width="400"/>

We first set out with sentinelHub's built in s2cloudless but realized that those are at only 60m resolution and thus does not yield great results, large swathes of wispy clouds would go undetected. The next process was to download s2Cloudless ourselves and run the cloud detection algorithm locally, this led to a significant improvement which we later realized would be even better when using FLOAT32 data.

While s2Cloudless was great when the clouds were against a contrasted background such as lush green mountains it was easy for s2Cloudless to create a perfect cloud mask, but alas, this was only for the best case scenario and we were a bit disappointed to see that it was more of a best case scenario. So we set out with our own method of further refining the cloud mask to include wispy clouds through K-means clustering which we originally were using in tandem with canny edge detection to detect the coastline.

Image below mosaic created from cloud mask generated by s2Cloudless using all bands.

<img src="/READMImages/composite_s2cloudless.jpg" width="400"/>

The move to K-means clustering and pre-processing the data further ourselves resulted in a K-clustered image that further brightened clouds, while this was a huge step forward in removing wispy clouds we were unable to make a refined cloud mask with the image as the cloud probability is different for each tile. If we were to refine the mask based on cloud probability on a single tile it would not translate well to the next tile where the luminance and other variables may be vastly different, thus the solution to this would most likely be an implementation of a machine learning library to adapt to each tile.

Image below is a base tile that may be chosen depending on cloud cover of other tile.

<img src="/READMImages/l2a_b11.png" width="400"/>

Image below is an image from a single tile using our composite method to define clouds.

<img src="/READMImages/rgb_quantized.png" width="400"/>


Image below is result from our own composite method.

<img src="/READMImages/composite_v2.jpg" width="400"/>

The mosaicking process simply followed a the cloud mask and cloud probability file to know which pixels to swap out, colour matching with the base tile used was achieved by matching the target tile's(which had the pixel to replace ) histogram, to the base tile.

## How to use
- Create your a trial account from sentinelHub and set them in the relevant client id, and secret field in get_maps.py
- Set the tiles you want to download with in the "sites" variable in get_maps.py, this must be in BBOX format.
- Run get_maps.py to download all n number of tiles for a site, this is currently set for 1 tile a week for 2 months.
- Once your tiles have been downloaded head over to process_mosaics to begin further cloud detection and mosaicking process.


## Notes
- The free sentinelHub trial allows about 40-50 queries if you are only using one site and downloading 4 tiles each time.


## Environment
Library versions at the time of testing
- Python 3.9.5
- opencv-python 4.5.3.56
- s2cloudless 1.5.0
- scikit-image 0.18.2
- scikit-learn 0.24.2
- sentinelhub 3.3.2
- sentinelsat 1.0.1
- sklearn 0.0
